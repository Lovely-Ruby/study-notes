<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <input type="file" name="" id="myfile" />
    进度：<progress value="0" max="100"></progress>
    <span class="progressValue">0%</span> 速度
    <span id="speed">0kb/s</span>
    <button id="upload">点击上传</button>
    <button id="cancel">取消上传</button>
  </body>
  <script>
    let xhr = new XMLHttpRequest();
    document.querySelector('#upload').onclick = function () {
      const imageData = document.querySelector('#myfile').files[0];
      let formData = new FormData();
      formData.append('name', '张三');
      formData.append('image', imageData);
      xhr.open('post', '/uploadImage', true);

      let oldDataSize;
      let oldTime;
      xhr.onload = function () {
        let responseText = xhr.responseText;
        console.log('上传成功', responseText);
      };
      xhr.upload.onloadstart = () => {
        console.log('上传开始！');
        oldLoaded = 0;
        oldTime = new Date();
      };
      xhr.upload.onprogress = (enent) => {
        // 如果想求出下载的速度：
        /**
         *  speed = d(dataSize)/d(time)
         */
        let duringLoaded = event.loaded - oldLoaded;
        let duringTime = (new Date() - oldTime) / 1000; // s
        let speed = duringLoaded / duringTime;
        let unit = 'bit/s';

        if (speed > 1024) {
          unit = 'kb/s';
          speed = speed / 1024;
        }
        if (speed > 1024) {
          unit = 'Mb/s';
          speed = speed / 1024;
        }
        if (speed > 1024) {
          unit = 'Gb/s';
          speed = speed / 1024;
        }

        document.querySelector('progress').value = parseInt(
          (event.loaded / event.total) * 100
        );
        document.querySelector('.progressValue').innerHTML =
          parseInt((event.loaded / event.total) * 100) + '%';
        document.querySelector('#speed').innerHTML = speed.toFixed(2) + unit;
        // console.log((duringLoaded / duringTime).toFixed(2) + "kb/s");

        // 记录旧的数据，下次循环的时候需要用的
        oldTime = new Date();
        oldLoaded = event.loaded;

        console.log('上传中');
        console.log(event);
      };
      xhr.upload.onloadend = () => {
        console.log('上传完成');
      };
      xhr.upload.onloadend = () => {
        console.log('上传完成');
      };
      xhr.upload.onabort = () => {
        console.log('取消上传');
      };
      xhr.send(formData);
    };
  </script>
</html>
